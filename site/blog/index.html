
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mydomain.org/mysite/blog/">
      
      
        <link rel="prev" href="..">
      
      
        <link rel="next" href="archive/2024/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.38">
    
    
      
        <title>Blog - My Docs</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.8c3ca2c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#blog" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="My Docs" class="md-header__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            My Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Blog
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="My Docs" class="md-nav__button md-logo" aria-label="My Docs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    My Docs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Welcome to MkDocs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Blog
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
    
      
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Blog
  </span>
  

      </a>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Archive
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Archive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    
  
  
    <li class="md-nav__item">
      <a href="archive/2024/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    2024
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
  <div class="md-content" data-md-component="content">
    <div class="md-content__inner">
      <header class="md-typeset">
        <h1 id="blog">Blog</h1>
      </header>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-05-06"><a class="toclink" href="2024/05/06/2024-05-06/">2024 05 06</a></h2>
<ul>
<li>2024-05-05 부터 시작해, 아이디어를 모두 정리하여 README.md 를 작성.</li>
<li>전부터 생각만 하던, FastAPI에 airflow webserver 를 mount 해서 기동하면 어떨까? 를 실현. 생각보다 매끄럽게 잘 되서 놀랐다.</li>
<li>당장의 목표는 airflow standalone 명령의 재현으로, 각 컴포넌트는 개별 subprocess 로 만들어질 듯 싶다.</li>
<li>가급적 asyncio 만 쓰고 싶었는데, polling 처리가 너무 어렵다. sh 를 쓴다.</li>
<li>그러나 그렇게 되면, sqlite 의 thread 접근을 따져가면서 사용해야 하므로 불편하다. 궁국적으로는 scheduler, worker, triggerer, dagparser 등을 asyncio 안에 녹여내어야 할 것이다.</li>
<li>그러면, uvicorn 워커가 늘어나면 어떻게 됨? 이란 질문이 생길 수 있는데, 늘리는데에 있어서 장점이 없다. 라고 할 수 있겠다.</li>
<li>어떻게 작동시키는데는 성공했고, WSL1 의 제약 때문에 (마치 NFS 에 있는 sqlite 를 쓰는데 문제가 있듯) sqlite 가 동시 접근을 당하자 프로세스가 죽어버렸다.</li>
<li>이 문제 해결을 위해서라도 스케쥴링 로직을 async 하게 고쳐야 한다.</li>
<li>triggerer 는 async 를 쓸테니, async 한 db 접근자가 있을 것이라 가정하고 코드를 따라가 보았다.<ul>
<li>그러지 않았다.</li>
<li>job runner 가 이벤트 루프를 위한 Tread 를 하나 만든다. 그 안에서 asyncio.run() 한다. </li>
<li>job runner의 메인 스레드와 asyncio 를 위한 스레드는 프로세스 분기가 아니라 스레드 분기이므로, 값을 주고 받을 수 있다.</li>
<li>job runner의 메인 스레드가 루프를 돌아 db에서 값을 만들어 열심히 deque 를 채우면, asyncio 루프에서 열심히 소비한다.</li>
</ul>
</li>
<li>즉, 이 구조는 일단 멀티 스레드이다. WSL의 sqlite 동시성 극복으로는 쓸 수 없다.</li>
<li>네이티브하게 async 하고 싶다면, sqlalchemy 부터 어떻게 해야 한다.</li>
<li>sqlalchemy==1.4.52 로, async API 가 존재는 한다. 그러나 이게 쓸 수 있다는 얘기는 아니다...</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-05-07"><a class="toclink" href="2024/05/06/2024-05-07/">2024 05 07</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-05-07/#_1">오늘의 계획</a></h3>
<ul>
<li>스케쥴러 프로세스를 이벤트 루프로 변환 할 수 있는지에 대한 간단한 검증 시작</li>
<li>state 에 flag 를 넣고 무한 루프를 돌리자. flag 가 변하면 루프를 끝내자.</li>
<li>flag 를 fastapi 에서 조회/변조 할 수 있는지 시험해보자.</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-05-07/#_2">해봤다!</a></h3>
<p><code>state 에 flag 를 넣고 무한 루프를 돌리자. flag 가 변하면 루프를 끝내자.</code>
lifespan 내에서 처리하니까 되긴 한다. 즉, 적-절한 옵션이 함께 한다면 가능은 하다!</p>
<p><code>flag 를 fastapi 에서 조회/변조 할 수 있는지 시험해보자.</code>
이건 한번에 달성 할 수 없었다. 값을 변경하려는 시도는 잘 작동하지 않았다.
ASGI 스펙을 다시 읽어보니 state 는 전적으로 application 의 제어에 있으며, server는 얕은 복사만 수행한다고 되어 있다.
그렇다면 dict of dict 하면 변조가 된다는 얘기렸다? -&gt; 된다.</p>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-05-07/#_3">오늘의 결론</a></h3>
<ul>
<li>job runner 를 잘 다듬으면 이벤트 루프로 변환 시킬 수 있다.</li>
<li>그렇게 만든 새 루프와 메인 루틴의 통신은 변수로 가능하다. (같은 프로세스의 같은 스레드 이므로)</li>
<li>한번 끄면 다시 켜는건 어려울 것 같다. pause 가 아니라 kill 이라 이름지어야 하겠다.</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-05-11"><a class="toclink" href="2024/05/06/2024-05-11/">2024 05 11</a></h2>
<h3 id="airflow-korea-meetup"><a class="toclink" href="2024/05/06/2024-05-11/#airflow-korea-meetup">airflow korea meetup</a></h3>
<p>이 날은 그 전날 갑자기 소식을 알게된 airflow 한국 밋업을 가게 되었음.</p>
<p>Korea Apache Airflow Meetup @Seoul Elice-Lab
https://www.meetup.com/apache-airflow-users-korea/events/299605465/</p>
<p>순서상 마지막의 라이트닝 토크에서 기회를 얻어서 이 repo 를 소개함. (횡설수설)
밋업 자체가 몇년만의 경험이라 마냥 즐거웠음.</p>
<p>미리 준비하지 않은 공유여서 그런지 잘 전달은 안 된 것 같고 이 고통은 나만의 고통이라는 점만 확인함. 
현장에서는 즐거웠는데, 기록으로 정리하려니까 그 점은 착잡하네...</p>
<p>이 날의 첫 발표 Airflow@우아한형제들의 발표자이신 박준영님이 이벤트 드리븐이라는 설명에 아래 발표를 공유해주셨음
https://airflowsummit.org/sessions/2023/event-based-dag-parsing-no-more-f5ing-in-the-ui/
읽어보니 watchdog 를 써서 airflow 의 첫 5분 문제를 해결한 것으로, 내 문제와는 다른 문제를 해결한 것 이었다.</p>
<p>그리고 아래 2개의 AIP 의 존재를 알려주셨음. 매우 감사합니다.
https://cwiki.apache.org/confluence/display/AIRFLOW/AIP-67+Multi-team+deployment+of+Airflow+components
https://cwiki.apache.org/confluence/display/AIRFLOW/%5BWIP%5D+AIP-70+Migrating+to+asynchronous+programming</p>
<p>특히 AIP-67 는 멀티테넌트 관련 내용으로... 
현황 B 정도가 지금 내가 생각하는 내용인듯. 좀 더 읽어봐야 하겠다.</p>
<p>AIP 에 흥미로운 아이디어가 많다는 걸 발견함.
https://cwiki.apache.org/confluence/display/AIRFLOW/AIP-61+Hybrid+Execution</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-05-13"><a class="toclink" href="2024/05/06/2024-05-13/">2024 05 13</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-05-13/#_1">오늘의 계획</a></h3>
<ul>
<li>7일날 찾아두었던 state 를 갱신하는 뤂프를, unittest 할 수 있는지 확인하자.</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-05-13/#_2">해봤다!</a></h3>
<p>심플하게- 된다!</p>
<p>BackgroundTask 와는 다르게 uvicorn 도움 따위 필요없다.</p>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-05-13/#_3">그럼 뭐가 달라지는데?</a></h3>
<ul>
<li>회사에서 쓰는 supervisord-Ofelia-CeleryTask 라는 고작 로그 파일 쌓인걸 지우기 위해 하는 것 치고는 너무 과하게 복잡한 부분을 지워버릴 수 있다!</li>
<li>회사에서 쓰는 BackgroundTask 로 state 머신 만들어서 작업 종료 시키기... 부분을 개선 할 수 있다. 현재 tick 으로 livenessProbe 에 의존하는 괴상한 모양인데, 그럴 필요 없다!</li>
</ul>
<h3 id="_4"><a class="toclink" href="2024/05/06/2024-05-13/#_4">조금만 더?</a></h3>
<ul>
<li>_core 디렉토리로 지금까지 알아낸 구조를 옮겨넣자.</li>
</ul>
<p>너무 욕심냈다. 늦게 잠들기 전에 그만 둠.</p>
<p>어느 정도 말이 되는 방법인것 같다는 느낌을 받았음.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-05-23"><a class="toclink" href="2024/05/06/2024-05-23/">2024 05 23</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-05-23/#_1">오늘의 계획</a></h3>
<ul>
<li>1시간만 하기</li>
<li>그 안에 scheduler loop 화 성공시키기</li>
<li>다른건 욕심!</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-05-23/#_2">결과</a></h3>
<ul>
<li>1시간 보다 더함. 중간에 컴 꺼진게 좀 컸다.</li>
<li>스케쥴러 코드를 거의 다 가져왔다. <ul>
<li>async context 에서 try-except 를 재현하기 까다로워서 예외처리를 일단 포기 했다.</li>
<li>session 도 그런식으로 포기한게 1경우 있다.</li>
<li>dag parse 하는 별도의 process 가 기동하는데, 이를 분리하지 않아서 에러가 나는 듯 하다.<ul>
<li>airflow 가 하던대로 process 만들게 아니라... 다른 방법으로 해야 할 듯 함.<ul>
<li>scheduler 하듯 await loop 로 바꾸던가</li>
<li>그게 너무 어려우면 asyncio process pool executor 로 보내던가</li>
</ul>
</li>
</ul>
</li>
<li>그 프로세스가 airflow dag-processor 와 같은 코드를 사용하여 기동하는지는 잘 모르겠음.</li>
</ul>
</li>
<li>쉽게 갈려고 상속해서 만들었는데, 아마 곧 불가능해 질 것 같음.</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-06-08"><a class="toclink" href="2024/05/06/2024-06-08/">2024 06 08</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-06-08/#_1">오늘의 계획</a></h3>
<ul>
<li>scheduler loop 화 성공시키기</li>
<li>다른건 욕심!</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-06-08/#_2">진행</a></h3>
<ul>
<li>오랫만에 재개, 지난번에 완성을 못 했었다. 기억을 되살리는데만 해도 시간이 들 듯</li>
<li>readme.md 에 써있는 내용으로 시작. 기억과 다르게 스케쥴러의 loop 화는 일단은 이미 성공 했다.</li>
<li>문제라면 스케쥴링 루프가 곧 작업을 처리하는 코드이기도 하다는 것. 이건 사실 당연한게 uvicorn 이벤트 루프는 단일 프로세스니까....</li>
<li>작업 자체가 작동하는건 다른 프로세스로 보내버려야 한다.</li>
<li>sqlite 접근은 uvicorn 이벤트 루프에게 그대로 맡겨야 한다.</li>
<li>그래야 목표한 sqlite 로 여러 작업 처리 하는 방식이 가능하다..!</li>
<li>Sequential executor 를 교체해야 할 것 같다는 아이디어가 나옴.</li>
<li>AsgiExecutor 라는 이름을 만들고, custom executor 설정으로 실행 시킬 수 있음을 확인. (이름 갈이만 함)</li>
<li>loop.run_in_executor 를 이용해 process pool 로 넘겨야 한다. </li>
<li>Executing command: ['airflow', 'tasks', 'run', 'example_branch_dop_operator_v3', ... 를 보니 --raw 옵션이 없다. 즉, sqlite 접근을 할 것 이다.</li>
<li>예전 기억이 맞나 확인해보니 맞다. --raw 옵션을 넣어야 LocalJob 을 안 만든다. db 접근을 안하고 싶다면 --raw 가 필요하다.</li>
</ul>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-06-08/#_3">결과</a></h3>
<ul>
<li>불필요한 죽은 코드를 정리했다.</li>
<li>AsgiExecutor 란걸 만들 필요가 있다는걸 확인했다. 계획을 세웠다.</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-06-09"><a class="toclink" href="2024/05/06/2024-06-09/">2024 06 09</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-06-09/#_1">오늘의 계획</a></h3>
<ul>
<li>AsgiExecutor 를 await 하기!</li>
<li>다른건 욕심!</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-06-09/#_2">진행</a></h3>
<ul>
<li>--raw 옵션은 신경쓰지 않고 일단 작업해봄</li>
<li>--local 을 제꼈더니...</li>
</ul>
<pre><code>[SQL: UPDATE task_instance SET state=?, queued_by_job_id=?, updated_at=? WHERE task_instance.dag_id = ? AND task_instance.task_id = ? AND task_instance.run_id = ? AND task_instance.map_index = ?]
[parameters: ((None, None, '2024-06-09 14:33:04.563888', 'example_sla_dag', 'sleep_20', 'scheduled__2024-06-09T14:08:00+00:00', -1), (None, None, '2024-06-09 14:33:04.563891', 'example_sla_dag', 'sleep_20', 'scheduled__2024-06-09T14:10:00+00:00', -1), (None, None, '2024-06-09 14:33:04.563893', 'example_sla_dag', 'sleep_30', 'scheduled__2024-06-09T14:20:00+00:00', -1), (None, None, '2024-06-09 14:33:04.563894', 'example_sla_dag', 'sleep_30', 'scheduled__2024-06-09T14:22:00+00:00', -1))]
(Background on this error at: https://sqlalche.me/e/14/4xp6) (Background on this error at: https://sqlalche.me/e/14/7s2a)
</code></pre>
<p>job 이 생성 안되었기 때문에, sql 이 실패한다.
job 을 안 만드는건 어렵다. 고쳐야 할게 너무 많다.</p>
<p>WSL1 에서의 sqlite3 까지 지원하는건 너무 어려운 목표일까?</p>
<p>로컬에 적당한 db 를 만들고 (redis sql 해볼까..? 이것도 에바인가?)</p>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-06-09/#_3">결과</a></h3>
<ul>
<li>WSL1 에서의 sqlite3 지원을 위해 airflow 의 모든 db 접근을 이벤트루프에게만 맡기는건 아직은 어렵다.<ul>
<li>관련한 AIP 가 있었던 것 같은데...</li>
</ul>
</li>
<li>그 목표를 포기하자면 db 셋업이 필요하다.<ul>
<li>pip 로는 설치시키기 까다롭고..</li>
<li>따로 셋업 절차 만들긴 싫은데...</li>
<li>rust..?</li>
</ul>
</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              4 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-06-24"><a class="toclink" href="2024/05/06/2024-06-24/">2024 06 24</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-06-24/#_1">메모</a></h3>
<ul>
<li><a href="https://news.hada.io/topic?id=15456">메세지 큐 기반 아키텍쳐가 요즘 인기가 떨어지는 이유는?</a> 이란 해커뉴스를 봄<ul>
<li>Redis가 대부분의 케이스 및 캐싱까지 처리해서 더 이상 별도의 메시지 브로커 운영이 쓸모없어짐. Kafka는 정말 대규모로 가버림.</li>
<li>DB(광범위하게 봤을때)가 대규모 처리를 훨씬 잘하게 되면서, "일시적인"처리들을 메인 저장소에서 처리하게 됨</li>
<li>MQ 기반 아키텍처가 기대만큼 잘 작동하지 않는 다는 것을 알아버려서 이제 다른 방식을 사용함</li>
<li>사실은 이제 MQ 기술이 성숙기에 접어들어서, 사람들이 관련 글을 쓸만큼 흥미롭지는 않음. 하지만 여전히 널리 사용되고 있음</li>
</ul>
</li>
<li>요약 스레드 내용은 마지막 의견으로 정리 되는 듯</li>
<li>하지만 나는 다른 3가지도 일리 있다고 생각한다</li>
<li>특히 airflow 에 한 해서는, 굳이 메세지 큐를 태울 이유가 없다고 본다.</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-06-24/#_2">오늘의 계획</a></h3>
<ul>
<li>WSL1 환경이라서 안되는 거니 다른 환경에서 돌려보자</li>
<li>회사 컴에서 하는건 쉽지만... 이 레포에 회사컴 묻히기 싫음.</li>
<li>termux 에서 돌려보자</li>
</ul>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-06-24/#_3">진행</a></h3>
<ul>
<li>기억을 되살려서 폰에서 ssh-server 를 띄우는 중...</li>
<li>이전에 열심히 만들어 뒀던건 userland 내부에서 였단걸 깨달음.</li>
<li>termux 는 약간 다름</li>
<li>termux 내 proot 로 만든 ubunut 에서는 어째 잘 안됨...</li>
<li>중요한거 아니니 무시하고 termux 에서 바로 sshd</li>
<li>https://wiki.termux.com/wiki/Remote_Access 참고함. 비번은 asdf</li>
<li>ip 는 고정 안될 텐데 오늘은 신경 쓸 필요 전혀 없음.</li>
<li>접속 </li>
</ul>
<pre><code class="language-sh">[22:58:21.332] &gt; Exec server process not found
&gt; [2024-06-24 13:58:19] error This machine does not meet Visual Studio Code Server
&gt; 's prerequisites, expected either...
&gt;   - find libstdc++.so or ldconfig for GNU environments
&gt;   - find /lib/ld-musl-aarch64.so.1, which is required to run the Visual Studio C
&gt; ode Server in musl environments
[22:58:21.347] &gt; 
[22:58:21.362] &gt; 6b5b59277f5d: s
</code></pre>
<p>vscode Remote:Host 는 불가함.</p>
<p>code-server 를 설치하고 localhost:xxxx 로 접근해보자</p>
<p>termux 에서 곧바로 하니 실패함.</p>
<pre><code>+ tar -C ~/.local/lib -xzf ~/.cache/code-server/code-server-4.90.3-linux-arm64.tar.gz
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/native-watchdog/build/Release/watchdog.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/native-watchdog/build/Release/obj.target/watchdog.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/kerberos/build/Release/kerberos.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/kerberos/build/Release/obj.target/kerberos.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/windows-process-tree/build/Release/windows_process_tree.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/windows-process-tree/build/Release/obj.target/windows_process_tree.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/spdlog/build/Release/obj.target/spdlog.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/spdlog/build/Release/spdlog.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/windows-registry/build/Release/winregistry.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/windows-registry/build/Release/obj.target/winregistry.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/deviceid/build/Release/windows.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@vscode/deviceid/build/Release/obj.target/windows.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@parcel/watcher/build/Release/nothing.a: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@parcel/watcher/build/Release/obj.target/node_modules/node-addon-api/nothing.a’: Permission denied
tar: code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@parcel/watcher/build/Release/watcher.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/lib/vscode/node_modules/@parcel/watcher/build/Release/obj.target/watcher.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/node_modules/argon2/build-tmp-napi-v3/Release/obj.target/argon2.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/node_modules/argon2/lib/binding/napi-v3/argon2.node’: Permission denied
tar: code-server-4.90.3-linux-arm64/node_modules/argon2/build-tmp-napi-v3/Release/argon2.a: Cannot hard link to ‘code-server-4.90.3-linux-arm64/node_modules/argon2/build-tmp-napi-v3/Release/obj.target/argon2.a’: Permission denied
tar: code-server-4.90.3-linux-arm64/node_modules/argon2/build-tmp-napi-v3/Release/argon2.node: Cannot hard link to ‘code-server-4.90.3-linux-arm64/node_modules/argon2/lib/binding/napi-v3/argon2.node’: Permission denied
tar: Exiting with failure status due to previous errors
</code></pre>
<p>proot 상태에서 해보자</p>
<h3 id="_4"><a class="toclink" href="2024/05/06/2024-06-24/#_4">결과</a></h3>
<pre><code class="language-sh"># termux 켜기, 메뉴얼하게 sshd 열기
sshd
# 접속 방법 확인
whoami &amp;&amp; ifconfig

# ssh -p 8022  한 후, code-server 설치
proot-distro login ubuntu
curl -fsSL https://code-server.dev/install.sh | sh
# 비번 확인
cat  /root/.config/code-server/config.yaml
# 구동
code-server --bind-addr 0.0.0.0:8081
</code></pre>
<p>기대대로 잘 된다는 것을 확인 했다.
장비가 느려서 그리고 sqlite 라서 동시성이 강제로 1로 떨어졌기 때문에 느리게 반응했지만,
작업이 작동하는 사이에도 웹서버는 반응 했다.</p>
<p>다만 작업이 한참 진행 중이라면, scheduler heartbeat 는 갱신하지 못 했다.</p>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              2 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-06-30"><a class="toclink" href="2024/05/06/2024-06-30/">2024 06 30</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-06-30/#_1">메모</a></h3>
<ul>
<li>WSL1 환경에서 개발은 정말 어렵다. sqlite3 가 봉인된다고 봐야 함.</li>
<li>다른 환경을 알아보거나 sqlite3 에 의존하지 않아야 한다.</li>
<li>다른 환경 알아보기는 경제적인 문제해결 방법이 필요하다</li>
<li>sqlite3 의존 피하기는, 딱히 돈은 안들고, 개인 여가 시간만 쓰면 되나, 옳은 선택인가..?? 싶어진다. </li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-06-30/#_2">오늘의 계획</a></h3>
<ul>
<li>당분간 WSL1 환경을 유지해야 한다.</li>
<li>매번 재개 할 때 마다 기동법을 다시 찾으라 5분씩 쓰니 기동법을 공고히 하자.</li>
<li><code>make run</code> 을 만들자.<ul>
<li>[x] makefile 작성</li>
<li>[x] .github/workflow 작성</li>
<li>[x] branch project 설정</li>
</ul>
</li>
</ul>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-06-30/#_3">진행</a></h3>
<p>branch project 설정부터 진행 했다.
rulsets 라고 신 기능이 생긴모양? 2분 정도 어색하긴 했는데, 전 보다 훨씬 쓰기 편해진것으로 보임.</p>
<p>적용후, main 에 push 하여 설정된걸 확인.</p>
<pre><code>riir-airflow➜  riir-airflow git:(main) gp
Enumerating objects: 5, done.
Counting objects: 100% (5/5), done.
Delta compression using up to 32 threads
Compressing objects: 100% (3/3), done.
Writing objects: 100% (3/3), 307 bytes | 307.00 KiB/s, done.
Total 3 (delta 2), reused 0 (delta 0), pack-reused 0
remote: Resolving deltas: 100% (2/2), completed with 2 local objects.
remote: error: GH013: Repository rule violations found for refs/heads/main.
remote: Review all repository rules at http://github.com/rino0601/riir-airflow/rules?ref=refs%2Fheads%2Fmain
remote: 
remote: - Changes must be made through a pull request.
remote: 
To github.com:rino0601/riir-airflow.git
 ! [remote rejected] main -&gt; main (push declined due to repository rule violations)
error: failed to push some refs to 'github.com:rino0601/riir-airflow.git'
riir-airflow➜  riir-airflow git:(main) glog
riir-airflow➜  riir-airflow git:(main) git reset f600975
</code></pre>
<p>회사 업무때 했던건데, cccv 못 하니까 너무 불편하고 힘들다...
이렇게 내것으로 만드는 것이겠지.</p>
<p>키보드 느낌 달라서 불편한 점도 많이 있는 듯
집 컴 키보드는 게임할 땐 충분하지만, 타이핑 많아지면 시끄럽고 불편하다</p>
<p>make -C subdir 할때 export 해둔 환경 변수를 전달 하는 방법을 모르겠다. 그냥 subdir make 를 포기함.</p>
<p>pre-commit 설정을 진행 했고, 아직 코드가 적어서 fmt, lint 등으로 인한 변경은 적었다.
pyright 도 걸었는데, 이건 좀 많네;</p>
<p>유닛 테스트 적어놓은게 깨져있던걸 발견함. 살릴 방법이 마땅치 않아서 일단 성공하게 조건을 많이 풀어 둠.</p>
<p>멀쩡한 유닛테스트는 다음 목표로 삼아야 하겠다.</p>
<h3 id="_4"><a class="toclink" href="2024/05/06/2024-06-30/#_4">결과</a></h3>
<ul>
<li>make run 으로 개발 모드로 띄울 수 있게 되었다. 목표 달성.</li>
<li>pre-commit 으로 fmt, lint 등을 적용하게 되었다. 목표 달성.</li>
<li>
<p>.github/worflow 를 적용했다. 잘 작동한다. 목표 달성.</p>
</li>
<li>
<p>make run 취소시 ctrl^C 를 두번해야 한다. 사소한 이슈 발견.</p>
</li>
<li>README.md 에 이번에 작업한 내용이 적혀 있지 않다. 근데 너무 지침. 다음으로 미룬다.</li>
<li>이제 PR 을 쌓기로 결정하면서, 이 blog 가 불편해질 수 있다. PR 메세지로 옮겨야 할까? 고민.<ul>
<li>협업자가 등장하면, 그 사람의 의견을 들어야 하겠지. (방해된다는 확정적. (일기니까...!) 어떻게 대체할지를 의견을 구해야...)</li>
</ul>
</li>
<li>유닛 테스트, 타입 테스트에 대해, 조건은 걸었지만, 작동은 하고 있지 않다. 다음에 챙겨볼 것</li>
<li>미룬 과제 제외하고 다음 목표?<ul>
<li>기존 컴포넌트를 모두 evventloop 로 표현해보자. 현재 scheduler 만 loop 로 표현되어 있다.</li>
<li>이후 rust 로 바꾸기 용이해 질 것 같음.</li>
</ul>
</li>
</ul>
    
  </div>
</article>
      
        <article class="md-post md-post--excerpt">
  <header class="md-post__header">
    
    <div class="md-post__meta md-meta">
      <ul class="md-meta__list">
        <li class="md-meta__item">
          <time datetime="2024-05-06 00:00:00">May 6, 2024</time></li>
        
        
          
          <li class="md-meta__item">
            
              1 min read
            
          </li>
        
      </ul>
      
    </div>
  </header>
  <div class="md-post__content md-typeset">
    <h2 id="2024-07-29"><a class="toclink" href="2024/05/06/2024-07-29/">2024 07 29</a></h2>
<h3 id="_1"><a class="toclink" href="2024/05/06/2024-07-29/#_1">오늘의 계획</a></h3>
<ul>
<li>한달만의 재개. 길게 할 수도 없고, README 갱신 정도를 목표로 하자.</li>
<li>하는 김에, examples 를 끄고, 이 프로젝트의 DAG 를 보게 하자.</li>
</ul>
<h3 id="_2"><a class="toclink" href="2024/05/06/2024-07-29/#_2">진행</a></h3>
<p>지난번에 branch protection 을 걸었으니 브랜치를 만들며 시작.</p>
<p>https://stackoverflow.com/questions/72929081/what-is-github-contributing-md-for
그리고
https://docs.github.com/en/communities/setting-up-your-project-for-healthy-contributions/setting-guidelines-for-repository-contributors 를 GPT의 도움을 받아 찾아냄.</p>
<p>개발환경 셋업 가이드는 .github/CONTRIBUTING.md 에 작성하기로 결정.</p>
<p>2023년 어느 시점엔가 (default-pre2.7 이란걸 보아 2.8부터 인듯?), airflow 가 설정의 근원을 더 세세하게 (provider 내장 설정 등등) 구분한다는 점을 발견함.</p>
<h3 id="_3"><a class="toclink" href="2024/05/06/2024-07-29/#_3">결과</a></h3>
<p>약간의 makefile 수정을 포함해서 의도대로 잘 진행 되었다.
생각보다 시간은 더 많이 씀.</p>
    
  </div>
</article>
      
      
        
          



<nav class="md-pagination">
  <span class="md-pagination__current">1</span> <a class="md-pagination__link" href="page/2/">2</a>
</nav>
        
      
    </div>
  </div>

          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6f25eb3.min.js"></script>
      
    
  </body>
</html>